name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy to Firebase
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Verify Firebase configuration files
        run: |
          echo "üîç Checking Firebase configuration..."
          if [ ! -f "firebase.json" ]; then
            echo "‚ùå firebase.json not found!"
            exit 1
          fi
          if [ ! -f ".firebaserc" ]; then
            echo "‚ùå .firebaserc not found!"
            exit 1
          fi
          if [ ! -f "public/index.html" ]; then
            echo "‚ùå public/index.html not found!"
            exit 1
          fi
          echo "‚úÖ All Firebase configuration files present"
      
      - name: Inject Firebase config into HTML
        run: |
          echo "üîß Injecting Firebase configuration..."
          
          # Use GitHub secrets or environment variables to inject Firebase config
          # This prevents committing sensitive keys to the repository
          
          if [ -n "${{ secrets.FIREBASE_WEB_API_KEY }}" ]; then
            echo "‚úÖ Firebase config available from secrets"
            
            # Replace placeholder values in index.html
            sed -i 's/YOUR_API_KEY/${{ secrets.FIREBASE_WEB_API_KEY }}/g' public/index.html
            sed -i 's/YOUR_PROJECT_ID.firebaseapp.com/${{ secrets.FIREBASE_AUTH_DOMAIN }}/g' public/index.html
            sed -i 's/YOUR_PROJECT_ID/${{ secrets.FIREBASE_PROJECT_ID }}/g' public/index.html
            sed -i 's/YOUR_PROJECT_ID.appspot.com/${{ secrets.FIREBASE_STORAGE_BUCKET }}/g' public/index.html
            sed -i 's/YOUR_MESSAGING_ID/${{ secrets.FIREBASE_MESSAGING_SENDER_ID }}/g' public/index.html
            sed -i 's/YOUR_APP_ID/${{ secrets.FIREBASE_APP_ID }}/g' public/index.html
            sed -i 's/YOUR_BACKEND_URL/${{ secrets.BACKEND_URL || 'https://photo2profit-backend-production.up.railway.app' }}/g' public/index.html
            
            echo "‚úÖ Firebase config injected successfully"
          else
            echo "‚ö†Ô∏è  Firebase secrets not configured - using defaults from firebase.json"
            echo "‚ÑπÔ∏è  To fix: Add Firebase secrets to GitHub repository settings"
          fi
      
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          projectId: ${{ secrets.FIREBASE_PROJECT_ID || 'photo2profit-ai' }}
          channelId: live
        env:
          FIREBASE_CLI_PREVIEWS: hostingchannels
      
      - name: Deployment summary
        if: success()
        run: |
          echo "üéâ Deployment successful!"
          echo "üì± Your app is live at: https://${{ secrets.FIREBASE_PROJECT_ID || 'photo2profit-ai' }}.web.app"
          echo ""
          echo "Next steps:"
          echo "1. Test your live application"
          echo "2. Verify Firebase authentication works"
          echo "3. Check Firebase Console for any errors"
          echo ""
          echo "Firebase Console: https://console.firebase.google.com/project/${{ secrets.FIREBASE_PROJECT_ID || 'photo2profit-ai' }}"
      
      - name: Deployment failed
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
          echo ""
          echo "Common issues:"
          echo "1. Check if FIREBASE_SERVICE_ACCOUNT secret is set correctly"
          echo "2. Verify Firebase project ID matches .firebaserc"
          echo "3. Ensure Firebase Hosting is enabled in console"
          echo "4. Check if billing is enabled (required for some features)"
          echo ""
          echo "Troubleshooting guide: See FIREBASE_SETUP.md"
